@* LLM Assist Modal for DecisionSpec Draft Generation *@
<div class="modal fade" id="llmAssistModal" tabindex="-1" aria-labelledby="llmAssistModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="llmAssistModalLabel">
                    <i class="bi bi-magic"></i> LLM-Assisted Spec Creation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="llmInstructionPanel">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>How it works:</strong> Describe what kind of decision process you want to create, 
                        and our AI will generate a draft DecisionSpec for you to review and refine.
                    </div>

                    <div class="mb-3">
                        <label for="llmInstruction" class="form-label">
                            Describe your decision process <small class="text-muted">(max 2000 characters)</small>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="llmInstruction" 
                            rows="6"
                            maxlength="2000"
                            placeholder="Example: Create a decision spec for determining the best cloud provider based on project requirements, budget constraints, and team expertise. Include questions about workload type, data sensitivity, scalability needs, and budget range."
                        ></textarea>
                        <div class="form-text">
                            <span id="llmCharCount">0</span> / 2000 characters
                        </div>
                    </div>

                    <div id="llmErrorPanel" class="alert alert-danger d-none">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span id="llmErrorMessage"></span>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-3" id="llmRetryButton">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                    </div>
                </div>

                <div id="llmLoadingPanel" class="text-center d-none py-5">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Generating...</span>
                    </div>
                    <h5>Generating your DecisionSpec draft...</h5>
                    <p class="text-muted">This may take 10-30 seconds</p>
                </div>

                <div id="llmSuccessPanel" class="d-none">
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i>
                        <strong>Draft generated successfully!</strong>
                        Review the draft below and click "Use This Draft" to load it into the editor.
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <strong>Draft Preview</strong>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-3">Spec ID:</dt>
                                <dd class="col-sm-9" id="llmDraftSpecId">-</dd>

                                <dt class="col-sm-3">Name:</dt>
                                <dd class="col-sm-9" id="llmDraftName">-</dd>

                                <dt class="col-sm-3">Description:</dt>
                                <dd class="col-sm-9" id="llmDraftDescription">-</dd>

                                <dt class="col-sm-3">Questions:</dt>
                                <dd class="col-sm-9" id="llmDraftTraitCount">0</dd>

                                <dt class="col-sm-3">Outcomes:</dt>
                                <dd class="col-sm-9" id="llmDraftOutcomeCount">0</dd>

                                <dt class="col-sm-3">Status:</dt>
                                <dd class="col-sm-9">
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-exclamation-triangle"></i> Unverified Draft - Requires Review
                                    </span>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="llmGenerateButton">
                    <i class="bi bi-magic"></i> Generate Draft
                </button>
                <button type="button" class="btn btn-success d-none" id="llmUseDraftButton">
                    <i class="bi bi-check-lg"></i> Use This Draft
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function() {
            const modal = document.getElementById('llmAssistModal');
            const instructionTextarea = document.getElementById('llmInstruction');
            const charCountSpan = document.getElementById('llmCharCount');
            const generateButton = document.getElementById('llmGenerateButton');
            const useDraftButton = document.getElementById('llmUseDraftButton');
            const retryButton = document.getElementById('llmRetryButton');
            
            const instructionPanel = document.getElementById('llmInstructionPanel');
            const loadingPanel = document.getElementById('llmLoadingPanel');
            const successPanel = document.getElementById('llmSuccessPanel');
            const errorPanel = document.getElementById('llmErrorPanel');
            const errorMessage = document.getElementById('llmErrorMessage');

            let currentDraft = null;
            let currentDraftId = null;

            // Character counter
            instructionTextarea.addEventListener('input', function() {
                charCountSpan.textContent = this.value.length;
            });

            // Generate button handler
            generateButton.addEventListener('click', async function() {
                const instruction = instructionTextarea.value.trim();
                
                if (!instruction) {
                    alert('Please enter an instruction');
                    return;
                }

                if (instruction.length > 2000) {
                    alert('Instruction must be 2000 characters or less');
                    return;
                }

                await generateDraft(instruction);
            });

            // Retry button handler
            retryButton.addEventListener('click', async function() {
                errorPanel.classList.add('d-none');
                const instruction = instructionTextarea.value.trim();
                await generateDraft(instruction);
            });

            // Use draft button handler
            useDraftButton.addEventListener('click', function() {
                if (currentDraft) {
                    // Populate the edit form with the draft
                    populateFormWithDraft(currentDraft);
                    
                    // Close modal
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    modalInstance.hide();

                    // Show success message
                    showToast('Draft loaded successfully. Please review and save.', 'success');
                }
            });

            // Reset modal on close
            modal.addEventListener('hidden.bs.modal', function() {
                resetModal();
            });

            async function generateDraft(instruction) {
                // Show loading
                showPanel('loading');
                generateButton.classList.add('d-none');

                try {
                    const response = await fetch('/api/decisionspecs/llm-drafts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-KEY': 'admin-key' // TODO: Get from config
                        },
                        body: JSON.stringify({ instruction: instruction })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || error.details || 'Failed to generate draft');
                    }

                    const data = await response.json();
                    currentDraft = data.spec;
                    currentDraftId = data.draftId;

                    // Update success panel
                    document.getElementById('llmDraftSpecId').textContent = data.spec?.specId || '-';
                    document.getElementById('llmDraftName').textContent = data.spec?.metadata?.name || '-';
                    document.getElementById('llmDraftDescription').textContent = data.spec?.metadata?.description || '-';
                    document.getElementById('llmDraftTraitCount').textContent = data.spec?.traits?.length || 0;
                    document.getElementById('llmDraftOutcomeCount').textContent = data.spec?.outcomes?.length || 0;

                    // Show success panel
                    showPanel('success');
                    useDraftButton.classList.remove('d-none');

                } catch (error) {
                    console.error('Error generating draft:', error);
                    errorMessage.textContent = error.message;
                    errorPanel.classList.remove('d-none');
                    showPanel('instruction');
                    generateButton.classList.remove('d-none');
                }
            }

            function showPanel(panel) {
                instructionPanel.classList.add('d-none');
                loadingPanel.classList.add('d-none');
                successPanel.classList.add('d-none');

                switch(panel) {
                    case 'instruction':
                        instructionPanel.classList.remove('d-none');
                        break;
                    case 'loading':
                        loadingPanel.classList.remove('d-none');
                        break;
                    case 'success':
                        successPanel.classList.remove('d-none');
                        break;
                }
            }

            function resetModal() {
                instructionTextarea.value = '';
                charCountSpan.textContent = '0';
                currentDraft = null;
                currentDraftId = null;
                errorPanel.classList.add('d-none');
                generateButton.classList.remove('d-none');
                useDraftButton.classList.add('d-none');
                showPanel('instruction');
            }

            function populateFormWithDraft(draft) {
                // Populate SpecId
                const specIdInput = document.getElementById('SpecId');
                if (specIdInput) specIdInput.value = draft.specId || '';

                // Populate Version
                const versionInput = document.getElementById('Version');
                if (versionInput) versionInput.value = draft.version || 'V1.0.0.0';

                // Populate Metadata
                if (draft.metadata) {
                    const nameInput = document.getElementById('Metadata_Name');
                    if (nameInput) nameInput.value = draft.metadata.name || '';

                    const descInput = document.getElementById('Metadata_Description');
                    if (descInput) descInput.value = draft.metadata.description || '';
                }

                // TODO: Populate questions and outcomes using the form's JavaScript API
                // This would require integration with the existing question/outcome editor code

                // For now, show a message that user needs to review
                alert('Draft data has been loaded into the form. Please review all fields, especially questions and outcomes, before saving.');
            }

            function showToast(message, type = 'info') {
                // Simple toast notification (could be replaced with a proper toast library)
                const alertClass = type === 'success' ? 'alert-success' : 'alert-info';
                const toast = document.createElement('div');
                toast.className = `alert ${alertClass} position-fixed top-0 start-50 translate-middle-x mt-3`;
                toast.style.zIndex = '9999';
                toast.innerHTML = `<i class="bi bi-check-circle"></i> ${message}`;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        })();
    </script>
}
